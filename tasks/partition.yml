---
- name: Wipe install drive and all its partitions
  ansible.builtin.command:
    cmd: find /dev -wholename "{{ install_drive }}*" -exec wipefs --force --all {} \;
  tags:
    - wipefs

- name: Create EFI Boot partition
  parted:
    device: '{{ install_drive }}'
    label: gpt
    number: "{{ item.num }}"
    part_start: "{{ item.start }}"
    part_end: "{{ item.end }}"
    name: "{{ item.name }}"
    # Can't use flags: here because
    #   The first partition is the only one that can validly have a flag
    #   If the flag: keyword is present, parted will try to set that flag
    #    even if the flag is blank, which will cause a syntax error in the parted
    #    commmand.
    state: present
  when: boottype == "efi"
  loop:
    - { num: 1, start: "0%", end: "512MB", name: "boot" }
    - { num: 2, start: "513MB", end: "100%", name: "root" }
  tags:
    - repartition

- name: Create EFI Boot partition flag
  parted:
    device: '{{ install_drive }}'
    label: gpt
    number: 1
    flags: [esp]
    state: present
  when: boottype == "efi"
  tags:
    - repartition

# BIOS setup
- name: Create BIOS Boot partition
  parted:
    device: '{{ install_drive }}'
    label: gpt
    number: "{{ item.num }}"
    part_start: "{{ item.start }}"
    part_end: "{{ item.end }}"
    name: "{{ item.name }}"
    # Can't use flags: here because
    #   The first partition is the only one that can validly have a flag
    #   If the flag: keyword is present, parted will try to set that flag
    #    even if the flag is blank, which will cause a syntax error in the parted
    #    commmand.
    state: present
  when: boottype == "bios"
  loop:
    - { num: 1, start: "0%", end: "1MB", name: "bios" }
    - { num: 2, start: "1MB", end: "513MB", name: "boot" }
    - { num: 3, start: "513MB", end: "100%", name: "root" }
  tags:
    - repartition

- name: Create BIOS Boot partition flag
  parted:
    device: '{{ install_drive }}'
    label: gpt
    number: 1
    flags: [bios_grub]
    state: present
  when: boottype == "bios"
  tags:
    - repartition
